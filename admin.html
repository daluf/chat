<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <link rel="stylesheet" href="/style.css">

    <title>Hello, admin!</title>
  </head>
  <body>

    <div class="login-wrapper">
      <div class="login-card">
        <div class="login-title">
          Admin Login
        </div>

        <div>
          <input id="passwordInput" class="username-field" type="password" class="form-control" placeholder="Password" aria-label="Password" aria-describedby="basic-addon1">
        </div>

        <div>
          <button onclick="login();" type="button" class="btn btn-primary login-button">Login</button>
        </div>
      </div>
	</div>

	<div class="row admin-ui">
		<div class='col-12 create'>
			Create Room
			<div class="row">
				<div class="col-6 input-group mb-3">
					<div class="input-group-prepend">
					</div>
					<input type="text" class="form-control" id="roomName" placeholder="Room Name" aria-label="" aria-describedby="basic-addon1">
				</div>
				<div class="col-6 input-group">
					<div class="input-group-prepend">
						<div style="height: 71%" class="input-group-text">
							<label style="margin-bottom: 0rem;">
								<input type="radio" value="public" checked="checked" name="radio">
								&nbsp;Public
							</label>
						</div>
					</div>
					<div class="input-group-prepend">
						<div style="height: 71%" class="input-group-text">
							<label style="margin-bottom: 0rem;">
								<input type="radio" value="private" name="radio">
								&nbsp;Private
							</label>
						</div>
					</div>
				</div>

			</div>
			<div class="text-right">
				<button style="position: relative; top: 15px;" onclick="createRoom();" type="button" class="btn btn-primary pull-right">Create</button>
			</div>
		</div>
		<div class="row col-12" id="roomies">

		</div>
		<div style="margin-top: 15px;" class="row col-12 whitelist">
			<div class="input-group mb-3">
				<input type="text" class="form-control" id="whitelistInput" placeholder="Add to Whitelist">
				<div class="input-group-append">
					<button class="btn btn-outline-secondary" type="button" onclick="whitelistUser();" id="button-addon2">Add User</button>
				</div>
			</div>
			<div class="col-12">
				<div id="whitelistedUsers" class="list-group">
				</div>
			</div>
		</div>

	</div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.26.13/dist/sweetalert2.all.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
	const socket = io();

	let keys = [];

	$( document ).ready(function() {
		$(".admin-ui").hide();
		let input = document.getElementById('passwordInput');
		input.focus();
		input.select();
	});

	function createRoom() {
		let name = $("#roomName").val();
		let state = $("input[name='radio']:checked").val();
		if (name && state) {
			socket.emit('createNewRoom', name, state)
		}
	}

	function whitelistUser() {
		socket.emit("whitelistUser", $("#whitelistInput").val(), (user, id) => {
			console.log(user, id);
			$.tmpl('<button id="Whitelist'+id+'" type="button" onclick="removeFromWhitelist('+id+')" class="list-group-item list-group-item-action">${user}</button>', {user: user}).prependTo( "#whitelistedUsers" );
		})
	}

	function login() {
    	socket.emit('adminLogin', $("#passwordInput").val()); // Take Value in Input Field "usernameText" and send to Server
	};

	function setPublic(room) {
		socket.emit('setRoomState', keys[room], "public")
	}

	function setPrivate(room) {
		socket.emit('setRoomState', keys[room], "private")
	}

	function removeRoom(room) {
		socket.emit('removeRoom', keys[room])
	}

	function setPublic2(room) {
		socket.emit('setRoomState', keys[room], "public")
	}

	function setPrivate2(room) {
		socket.emit('setRoomState', keys[room], "private")
	}

	function removeRoom2(room) {
		socket.emit('removeRoom', room)
	}

	function removeFromWhitelist(id) {
		socket.emit('removeFromWhitelist', id, (data) => {
			$('#Whitelist'+data).remove();
		});
	}

	socket.on('roomCreate', function(name, state) {
		if (state == 'public') {
			$.tmpl( "<div id="+name+"RoomDiv"+" class='col-3 room'><i id="+name+" style='color: rgb(0, 160, 0);' class='fas fa-lock-open'></i> "+name+" <div class='dropdown text-right'><button class='btn btn-primary dropdown-toggle' type='button' id='dropdownMenuButton' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'></button><div class='dropdown-menu' aria-labelledby='dropdownMenuButton'><a onclick='setPublic2("+name+")' class='dropdown-item'>Public</a><a onclick='setPrivate2("+name+")' class='dropdown-item'>Private</a><a onclick='removeRoom2( "+name+" )' class='dropdown-item btn-danger'>Delete</a></div></div></div>").appendTo( "#roomies" );
		} else if (state == 'private') {
			$.tmpl( "<div id="+name+"RoomDiv"+" class='col-3 room'><i id="+name+" style='color: rgb(177,0,0);' class='fas fa-lock'></i> "+name+" <div class='dropdown text-right'><button class='btn btn-primary dropdown-toggle' type='button' id='dropdownMenuButton' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'></button><div class='dropdown-menu' aria-labelledby='dropdownMenuButton'><a onclick='setPublic2("+name+")' class='dropdown-item'>Public</a><a onclick='setPrivate2("+name+")' class='dropdown-item'>Private</a><a onclick='removeRoom2( "+name+" )' class='dropdown-item btn-danger'>Delete</a></div></div></div>").appendTo( "#roomies" );
		}
	})

	socket.on('isPublic', function(room) {
		$("#"+room).removeClass('fas fa-lock-open')
		$("#"+room).removeClass('fas fa-lock')
		$("#"+room).addClass('fas fa-lock-open').css('color', 'rgb(0, 160, 0)')
	})

	socket.on('isPrivate', function(room) {
		$("#"+room).removeClass('fas fa-lock-open')
		$("#"+room).removeClass('fas fa-lock')
		$("#"+room).addClass('fas fa-lock').css('color', 'rgb(177, 0, 0)')
	})

	socket.on('roomDeleted', function(room) {
		$("#"+room+"RoomDiv").remove('')
	})

	socket.on('yesYouAreAdmin', function() {
		$(".login-wrapper").hide();
		$(".admin-ui").show();
		socket.emit('requestChatRooms')
		socket.emit('requestWhitelist', (whitelist) => {
			for (i = 0; i < whitelist.length; i++) {
				$.tmpl('<button id="Whitelist'+i+'" type="button" onclick="removeFromWhitelist('+i+')" class="list-group-item list-group-item-action">${user}</button>', {user: whitelist[i]}).prependTo( "#whitelistedUsers" );
			}
		})
	})

	socket.on('responseChatRooms', function(rooms) {
		rooms = rooms
		console.log(Object.keys(rooms));
		keys = Object.keys(rooms);
		for (i = 0; i < Object.keys(rooms).length; i++) {
			let key = Object.keys(rooms)[i]
			if (rooms[key].privacy == 'public') {
				$.tmpl( "<div id="+key+"RoomDiv"+" class='col-3 room'><i id="+key+" style='color: rgb(0, 160, 0);' class='fas fa-lock-open'></i> ${key} <div class='dropdown text-right'><button class='btn btn-primary dropdown-toggle' type='button' id='dropdownMenuButton' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'></button><div class='dropdown-menu' aria-labelledby='dropdownMenuButton'><a onclick='setPublic(${room})' class='dropdown-item'>Public</a><a onclick='setPrivate(${room})' class='dropdown-item'>Private</a><a onclick='removeRoom( ${room} )' class='dropdown-item btn-danger'>Delete</a></div></div></div>", {"key": key, "room": i}).appendTo( "#roomies" );
			} else if (rooms[key].privacy == 'private') {
				$.tmpl( "<div id="+key+"RoomDiv"+" class='col-3 room'><i id="+key+" style='color: rgb(177,0,0);' class='fas fa-lock'></i> ${key} <div class='dropdown text-right'><button class='btn btn-primary dropdown-toggle' type='button' id='dropdownMenuButton' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'></button><div class='dropdown-menu' aria-labelledby='dropdownMenuButton'><a onclick='setPublic(${room})' class='dropdown-item'>Public</a><a onclick='setPrivate(${room})' class='dropdown-item'>Private</a><a onclick='removeRoom( ${room} )' class='dropdown-item btn-danger'>Delete</a></div></div></div>", {"key": key, "room": i}).appendTo( "#roomies" );
			}
		}
	})

	$("#whitelistInput").keypress(function(e) {
		if(e.which == 13) {
			if ($("#whitelistInput").val()) {
				socket.emit("whitelistUser", $("#whitelistInput").val(), (user, id) => {
					id = id-1
					console.log(user, id);
					$.tmpl('<button id="Whitelist'+id+'" type="button" onclick="removeFromWhitelist('+id+')" class="list-group-item list-group-item-action">${user}</button>', {user: user}).prependTo( "#whitelistedUsers" );
				})
				$("#whitelistInput").val('');
			}
		}
	});

	$("#passwordInput").keypress(function(e) {
		if(e.which == 13) {
			if ($("#passwordInput").val()) {
				socket.emit('adminLogin', $("#passwordInput").val());
				$("#passwordInput").val('');
			}
		}
	});

    </script>
  </body>
</html>
